<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.demo.mall.dao.ProductMapper">

    <sql id="prodAndShopNameWithNoContent_SQL">
        p.prod_id,
        p.pic,
        p.prod_name,
        p.price,
        p.brief,
        sd.`shop_name`
    </sql>

    <update id="returnStock">
        <foreach collection="prodCollect" item="changeStocks" index="prodId" separator=";">
            UPDATE tz_prod
            SET total_stocks = total_stocks + #{changeStocks}
            WHERE prod_id = #{prodId}
        </foreach>
    </update>

    <select id="pageByCategoryId" resultType="com.demo.mall.bean.app.dto.ProductDto">
        SELECT tp.*,tc.category_name,tsd.shop_name FROM tz_prod tp
        LEFT JOIN tz_category tc ON tp.category_id = tc.category_id
        LEFT JOIN tz_shop_detail tsd ON tp.shop_id = tsd.shop_id
        WHERE tp.status = 1
        <if test="categoryId != null">
            AND tp.category_id = #{categoryId}
        </if>
    </select>

    <select id="pagePutAwayTime" resultType="com.demo.mall.bean.app.dto.ProductDto">
        SELECT
        <include refid="prodAndShopNameWithNoContent_SQL"/>
        FROM tz_prod p
        LEFT JOIN tz_shop_detail sd
        ON p.shop_id = sd.shop_id
        WHERE `status` = 1
        ORDER BY putaway_time DESC
    </select>

    <select id="pageByTagId" resultType="com.demo.mall.bean.app.dto.ProductDto">
        SELECT
        <include refid="prodAndShopNameWithNoContent_SQL"/>
        FROM tz_prod p
        LEFT JOIN tz_prod_tag_reference ptr
        ON ptr.`prod_id` = p.`prod_id`
        LEFT JOIN tz_prod_tag pt
        ON pt.`id` = ptr.`tag_id`
        LEFT JOIN tz_shop_detail sd
        ON p.shop_id = sd.shop_id
        WHERE pt.`id` = #{tagId}
        AND p.status = 1
        ORDER BY p.`update_time` DESC
    </select>

    <select id="moreBuyProdList" resultType="com.demo.mall.bean.app.dto.ProductDto">
        SELECT
        <include refid="prodAndShopNameWithNoContent_SQL"/>
        FROM tz_prod p
        LEFT JOIN tz_shop_detail sd
        ON p.shop_id = sd.shop_id
        WHERE p.`status` = 1
        ORDER BY p.`sold_num` DESC, p.`update_time` DESC
    </select>

    <select id="tagProdList" resultType="com.demo.mall.bean.app.dto.TagProductDto">
        SELECT pt.*,
        <include refid="prodAndShopNameWithNoContent_SQL"/>
        FROM tz_prod_tag pt --獲取分組訊息
        LEFT JOIN
        (-- 分組獲取各組前6
        SELECT ptr.* FROM tz_prod_tag_reference ptr
        INNER JOIN tz_prod p3 ON p3.`prod_id` = ptr.`prod_id` AND p3.`status` =1
        WHERE
        (SELECT COUNT(0) FROM tz_prod_tag_reference prt2
        INNER JOIN tz_prod p2 ON p2.`prod_id` = prt2.`prod_id` AND p2.`status` =1
        WHERE prt2.`tag_id` = ptr.`tag_id` AND prt2.`create_time` > ptr.`create_time`)&lt;6
        ORDER BY ptr.`tag_id`,ptr.`create_time` DESC
        )AS temp
        ON temp.`tag_id` = pt.`id`
        LEFT JOIN tz_prod p -- 獲取商品詳細訊息
        ON p.`prod_id` = temp.`prod_id`
        LEFT JOIN tz_shop_detail sd -- 獲取商店訊息
        ON p.shop_id = sd.shop_id
        ORDER BY pt.`seq` DESC
    </select>

    <select id="collectionProds" resultType="com.demo.mall.bean.app.dto.ProductDto">
        SELECT
        <include refid="prodAndShopNameWithNoContent_SQL"/>
        FROM tz_prod p
        LEFT JOIN tz_shop_detail sd
        ON p.shop_id = sd.shop_id
        WHERE p.`prod_id` IN
        (SELECT uc.`prod_id` FROM tz_user_collection uc
        WHERE uc.user_id = #{userId})
    </select>

</mapper>