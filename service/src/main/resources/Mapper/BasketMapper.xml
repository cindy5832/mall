<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.demo.mall.dao.BasketMapper">

    <update id="updateDiscountItemId">
        <foreach collection="basketIdShopCartParamMap" index="key" item="shopCartParam" separator=";">
            UPDATE tz_basket
            SET discount_id = #{shopCartParam.discountId}
            WHERE basket_id = #{key} AND user_id =
            #{userId}
        </foreach>
    </update>

    <delete id="deleteShopCartItemsByBasketIds">
        DELETE FROM tz_basket
        WHERE user_id = #{userId} AND basket_id IN
        <foreach collection="basketIds" item="basketId" open="(" separator="," close=")">
            #{basketId}
        </foreach>
    </delete>

    <delete id="deleteAllShopCartItems">
        DELETE
        FROM tz_basket
        WHERE user_id = #{userId}
    </delete>

    <delete id="cleanExpiryProdList">
        DELETE
        FROM tz_basket
        WHERE basket_id IN (SELECT basket_id
                            FROM (SELECT tb.basket_id basket_id
                                  FROM tz_basket tb
                                           LEFT JOIN tz_shop_detail tsd
                                                     ON tb.shop_id = tsd.shop_id
                                           LEFT JOIN tz_prod tp
                                                     ON tb.prod_id = tp.prod_id
                                           LEFT JOIN tz_sku ts
                                                     ON tb.sku_id = ts.sku_id
                                  WHERE tp.status = 0
                                     OR ts.status = 0 AND tb.user_id = #{userId}) AS temp)
    </delete>

    <select id="listUserIdsByProdId" resultType="java.lang.String">
        SELECT user_id
        FROM tz_basket
        WHERE prod_id = #{prodId}
    </select>

    <select id="getShopCartItems" resultType="com.demo.mall.bean.app.dto.ShopCartItemDto">
        SELECT tb.*,
               tb.basket_count        AS prod_count,
               tsd.shop_name,
               IFNULL(ts.pic, tp.pic) AS pic,
               ts.price,
               ts.ori_price,
               tp.brief,
               ts.properties,
               ts.prod_name,
               ts.sku_name
        FROM tz_basket tb
                 LEFT JOIN tz_shop_detail tsd ON tb.shop_id = tsd.shop_id
                 LEFT JOIN tz_prod tp ON tb.prod_id = tp.prod_id
                 LEFT JOIN tz_sku ts ON tb.sku_id = ts.sku_id
        WHERE tp.status = 1
          AND ts.status = 1
          AND tb.user_id = #{userId}
        ORDER BY tb.`basket_id` DESC
    </select>
</mapper>